<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CMPStats - Indiana</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg-dark: #0f172a; --bg-card: #1e293b; --accent: #1e40af; --text: #f1f5f9; --text-muted: #94a3b8; --border: #334155; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; padding: 2rem 1rem; }
    .container { max-width: 1200px; margin: 0 auto; }
    .back-btn { display: inline-block; color: var(--text-muted); text-decoration: none; margin-bottom: 1rem; font-size: 0.9rem; }
    .back-btn:hover { color: var(--text); }
    h1 { font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem; background: linear-gradient(135deg, #60a5fa, #1e40af); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; text-align: center; }
    .stat-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: #60a5fa; margin-top: 0.25rem; }
    h2 { font-size: 1.25rem; margin: 1.5rem 0 1rem; color: var(--text-muted); }
    table { width: 100%; border-collapse: collapse; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 2rem; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--accent); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(30, 64, 175, 0.1); }
    a { color: #60a5fa; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .lock-100 { color: #34d399; font-weight: 600; }
    .lock-90 { color: #fbbf24; font-weight: 600; }
    .lock-50 { color: #fb923c; font-weight: 600; }
    .lock-0 { color: #f87171; font-weight: 600; }
    .loading { color: var(--text-muted); font-style: italic; }
    .error { color: #f87171; padding: 1rem; }
    @media (max-width: 768px) { .events-table th:nth-child(4), .events-table td:nth-child(4) { display: none; } .ranks-table th:nth-child(5), .ranks-table td:nth-child(5) { display: none; } }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-btn">‚Üê back to home</a>
    <h1>Indiana District</h1>
    <div class="stats">
      <div class="stat-card"><div class="stat-label">Points Remaining</div><div class="stat-value" id="ptsRemaining">-</div></div>
      <div class="stat-card"><div class="stat-label">Champs Slots</div><div class="stat-value" id="dcmpSlots">32</div></div>
    </div>
    <h2>Events</h2>
    <table class="events-table">
      <thead><tr><th>Event</th><th>Week</th><th>Status</th><th>Type</th><th>Pts</th></tr></thead>
      <tbody id="eventsBody"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
    </table>
    <h2>Team Rankings</h2>
    <table class="ranks-table">
      <thead><tr><th>Rank</th><th>Team</th><th>E1</th><th>E2</th><th>Bonus</th><th>Total</th><th>Lock</th></tr></thead>
      <tbody id="ranksBody"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody>
    </table>
  </div>
<script>
const TBA_API_KEY = 'z8FSCVQr1QXVxRFn6GgWOfmVrTtQQ1GUxvs78aCgrigr6JqQaZZRdET6AIZ9Gm80';
const YEAR = 2026, DISTRICT = 'in', SLOTS = 32;
const eventTypeNames = {0:"Regional",1:"District",2:"DCMP",3:"Champs",4:"Finals",5:"Qualifier",6:"Offseason"};

function safe(val) { return (val === null || val === undefined || Number.isNaN(val)) ? '-' : val; }
function safeNum(val) { return (val === null || val === undefined || Number.isNaN(val)) ? 0 : Number(val); }

async function fetchTBA(endpoint) {
  try {
    const res = await fetch(`https://www.thebluealliance.com/api/v3${endpoint}`, {headers:{'X-TBA-Auth-Key':TBA_API_KEY}});
    if (!res.ok) throw new Error('API error');
    return await res.json();
  } catch(e) { console.error(e); return []; }
}

function getWeek(startDate) {
  if (!startDate) return '-';
  const date = new Date(startDate);
  const weekNum = Math.floor((date - new Date(YEAR, 2, 1)) / (7 * 24 * 60 * 60 * 1000)) + 1;
  return weekNum > 0 ? `W${weekNum}` : '-';
}

function getLockClass(pct) {
  if (pct >= 100) return 'lock-100'; if (pct >= 90) return 'lock-90'; if (pct >= 50) return 'lock-50'; return 'lock-0';
}

async function loadDistrict() {
  const [rankings, events] = await Promise.all([
    fetchTBA(`/district/${YEAR}${DISTRICT}/rankings`),
    fetchTBA(`/district/${YEAR}${DISTRICT}/events`)
  ]);

  if (!events || events.length === 0) {
    document.getElementById('eventsBody').innerHTML = '<tr><td colspan="5" class="error">No events found</td></tr>';
    document.getElementById('ptsRemaining').textContent = '0';
  } else {
    const now = new Date();
    let totalPts = 0;
    const eventsHtml = events.map(e => {
      const start = new Date(e.start_date), end = new Date(e.end_date);
      let status = 'Upcoming', pts = 220;
      if (now > end) { status = 'Done'; pts = 0; }
      else if (now >= start) { status = 'Active'; pts = 110; }
      if (e.event_type === 1 || e.event_type === 5) totalPts += pts;
      return `<tr>
        <td><a href="https://www.thebluealliance.com/event/${e.key}" target="_blank">${e.name}</a></td>
        <td>${getWeek(e.start_date)}</td>
        <td>${status}</td>
        <td>${eventTypeNames[e.event_type] || '-'}</td>
        <td>${pts}</td>
      </tr>`;
    }).join('');
    document.getElementById('eventsBody').innerHTML = eventsHtml;
    document.getElementById('ptsRemaining').textContent = safe(totalPts);
  }

  if (!rankings || rankings.length === 0) {
    document.getElementById('ranksBody').innerHTML = '<tr><td colspan="7" class="error">No rankings available</td></tr>';
  } else {
    const sorted = rankings.sort((a,b) => safeNum(b.point_total) - safeNum(a.point_total));
    const ranksHtml = sorted.map((t,i) => {
      const rank = i + 1;
      const cutoffIn = safeNum(sorted[SLOTS-1]?.point_total);
      const cutoffOut = safeNum(sorted[SLOTS]?.point_total);
      const totalPts = safeNum(document.getElementById('ptsRemaining').textContent);
      const gap = safeNum(t.point_total) - cutoffOut;
      let lock = 0;
      if (rank <= SLOTS) {
        lock = gap > totalPts ? 100 : (totalPts > 0 ? Math.min(99, Math.round((gap/totalPts)*50 + 50)) : 50);
      } else {
        const behind = cutoffIn - safeNum(t.point_total);
        lock = behind > totalPts ? 0 : (totalPts > 0 ? Math.round((1 - behind/totalPts)*50) : 0);
      }
      const e1 = safe(t.event_points?.[0]?.total);
      const e2 = safe(t.event_points?.[1]?.total);
      const bonus = safe(t.rookie_bonus);
      const total = safe(t.point_total);
      return `<tr>
        <td>${rank}</td>
        <td><a href="https://www.thebluealliance.com/team/${t.team_key?.slice(3)}" target="_blank">${t.team_key?.slice(3) || '-'}</a></td>
        <td>${e1}</td>
        <td>${e2}</td>
        <td>${bonus}</td>
        <td>${total}</td>
        <td class="${getLockClass(lock)}">${lock}%</td>
      </tr>`;
    }).join('');
    document.getElementById('ranksBody').innerHTML = ranksHtml;
  }
}

loadDistrict();
</script>
</body>
</html>
